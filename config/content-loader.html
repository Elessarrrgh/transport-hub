<script>
function waitForElement(selector, timeout = 2000) {
  return new Promise((resolve, reject) => {
    const start = Date.now();
    const interval = setInterval(() => {
      const el = document.querySelector(selector);
      if (el) {
        clearInterval(interval);
        resolve(el);
      } else if (Date.now() - start > timeout) {
        clearInterval(interval);
        reject("Element not found: " + selector);
      }
    }, 50);
  });
}

async function loadEventContent() {
  try {
    // --- Parse URL ---
    const parts = window.location.pathname.split("/").filter(Boolean);
    if (parts.length < 2) return;
    const showKey = parts[0].toLowerCase();

    // --- Fetch content-directory.json ---
    const dirUrl = "https://elessarrrgh.github.io/transport-hub/config/content-directory.json";
    const directory = await fetch(dirUrl + "?nocache=" + Date.now()).then(r => r.json());
    const showJsonUrl = directory[showKey];
    if (!showJsonUrl) return;

    // --- Fetch show JSON ---
    const showData = await fetch(showJsonUrl + "?nocache=" + Date.now()).then(r => r.json());

    
    // -------------------------------
    // Landing Page
    // -------------------------------

    // Update Title
    if (window.location.pathname.includes("/transport-hub")) {
      const titleEl = await waitForElement("[data-event-base='title']");
      if (titleEl && showData.base && showData.base.title) {
        titleEl.innerText = showData.base.title;
        console.log("Landing page title loaded:", showData.base.title);
      }

      // Update Event Map
      const mapEl = await waitForElement("[data-event-base='event-map']");
      if (mapEl && showData.base && showData.base["event-map"]) {
        mapEl.innerHTML = showData.base["event-map"];
        console.log("Landing page event-map loaded");
      }
    }

    // -------------------------------
    // Interactive Map Page
    // -------------------------------
    if (window.location.pathname.includes("/interactive-map")) {
      const mapIframe = await waitForElement("iframe.rounded-iframe");
      if (mapIframe && showData["interactive-map"]) {
        mapIframe.src = showData["interactive-map"];
        console.log("Interactive map src updated from JSON");
      }
    }

    // -------------------------------
    // Flight Info Page
    // -------------------------------
    if (window.location.pathname.includes("/flight-info")) {
      const flightInfo = showData["flight-info"];
      if (!flightInfo) return;

      // Arrivals Widget
      const arrivalsIframe = document.querySelector("#flight-arrivals-accordion iframe");
      if (arrivalsIframe && flightInfo["arrivals-widget"]) arrivalsIframe.src = flightInfo["arrivals-widget"];

      // Departures Widget
      const departuresIframe = document.querySelector("#flight-departures-accordion iframe");
      if (departuresIframe && flightInfo["departures-widget"]) departuresIframe.src = flightInfo["departures-widget"];
    }

  } catch (err) {
    console.error("Error loading event content:", err);
  }
}

document.addEventListener("DOMContentLoaded", loadEventContent);
</script>